jQuery(document).ready(function(){const i=jQuery;({status:null,auditState:{testId:"",criticalTotal:0,warningsTotal:0,stageName:"",log:[],summary:[],downloadUrl:""},dictionary:{status:{idle:"idle",requestNew:"requestNew",requestContinue:"requestContinue",error:"error",finished:"finished"},responseStatus:{continue:"continue",finished:"finished"},logLevel:{info:"info",warning:"warning",critical:"critical"},strings:{auditInProgress:"",auditCompleted:"",auditAbortedDueCriticalError:"",serverTest:"",pleaseWait:"",criticalProblemsTotal:"",warningsTotal:"",start:"",startAgain:"",criticalAjaxMessage:"",criticalErrorOccurredMessage:"",critical:"",criticalGenericMessage:""}},wpAjax:{adminAjaxUrl:"",adminAjaxActionName:"",autopayAction:{new:"new",continue:"continue"},nonce:"",strings:"",log:{request:{},response:{}}},elements:{buttons:{startBtn:null,downloadBtn:null,copyBtn:null},statusBox:{wrapper:"",icon:"",title:"",stageName:"",pleaseWait:"",counterWarning:"",counterCritical:""},log:{wrapper:""},summary:{wrapper:"",success:{item:"",header:""},error:{item:"",header:"",message:""},warning:{item:"",header:"",message:""}},hidden:{nonce:""}},getStatus:function(){return this.status},init:function(){try{null===this.status&&(this.resetAuditState,this.registerJqueryElements(),this.initDictionary(),this.updateUiReset(),this.status=this.dictionary.status.idle,this.initAjaxVars(),this.registerEvents())}catch(t){this.abort(t.message)}},initAjaxVars:function(){this.wpAjax.adminAjaxUrl=autopayAuditData.adminAjaxUrl,this.wpAjax.adminAjaxActionName=autopayAuditData.adminAjaxActionName,this.wpAjax.nonce=this.elements.hidden.nonce.val()},initDictionary:function(){this.dictionary.strings=autopayAuditData.strings},resetAuditState:function(){this.auditState.criticalTotal=0,this.auditState.warningsTotal=0,this.auditState.stageName="",this.auditState.log=[],this.auditState.summary=[],this.auditState.downloadUrl=""},updateStateTotal(t){t.level===this.dictionary.logLevel.warning&&(this.auditState.warningsTotal+=1),t.level===this.dictionary.logLevel.critical&&(this.auditState.criticalTotal+=1)},registerJqueryElements:function(){this.elements.buttons.startBtn=this.getJqueryElementByAttr("autopay_audit_btn_start","id"),this.elements.buttons.downloadBtn=this.getJqueryElementByAttr("autopay_audit_btn_download","id"),this.elements.buttons.copyBtn=this.getJqueryElementByAttr("autopay_audit_btn_copy","id"),this.elements.hidden.nonce=this.getJqueryElementByAttr("autopay_audit_nonce","id"),this.elements.statusBox.wrapper=this.getJqueryElementByAttr("autopay_audit_status","id"),this.elements.statusBox.icon=this.getJqueryElementByAttr("autopay_audit_status_icon","id"),this.elements.statusBox.title=this.getJqueryElementByAttr("autopay_audit_status_title","id"),this.elements.statusBox.stageName=this.getJqueryElementByAttr("autopay_audit_stage_name","id"),this.elements.statusBox.pleaseWait=this.getJqueryElementByAttr("autopay_audit_please_wait","id"),this.elements.statusBox.counterCritical=this.getJqueryElementByAttr("autopay_audit_counter_critical","id"),this.elements.statusBox.counterWarning=this.getJqueryElementByAttr("autopay_audit_counter_warning","id"),this.elements.log.wrapper=this.getJqueryElementByAttr("autopay_audit_log","id"),this.elements.summary.wrapper=this.getJqueryElementByAttr("autopay_audit_summary","id"),this.elements.summary.success.item=this.getJqueryElementByAttr("autopay_audit_s_s","id"),this.elements.summary.success.header=this.getJqueryElementByAttr("autopay_audit_s_s_h","id"),this.elements.summary.warning.item=this.getJqueryElementByAttr("autopay_audit_s_w","id"),this.elements.summary.warning.header=this.getJqueryElementByAttr("autopay_audit_s_w_h","id"),this.elements.summary.warning.message=this.getJqueryElementByAttr("autopay_audit_s_w_m","id"),this.elements.summary.error.item=this.getJqueryElementByAttr("autopay_audit_s_e","id"),this.elements.summary.error.header=this.getJqueryElementByAttr("autopay_audit_s_e_h","id"),this.elements.summary.error.message=this.getJqueryElementByAttr("autopay_audit_s_e_m","id")},updateUiStart:function(){this.resetAuditState(),this.updateUiReset(),this.elements.statusBox.icon.removeClass("completed").addClass("in-progress"),this.updateUiDisableStartBtn(),this.elements.statusBox.wrapper.show()},updateUiReset:function(){this.elements.buttons.startBtn.html(this.dictionary.strings.start),this.elements.statusBox.counterCritical.html("0"),this.elements.statusBox.counterWarning.html("0"),this.elements.statusBox.stageName.html(""),this.elements.statusBox.title.html(this.dictionary.strings.auditInProgress),this.elements.statusBox.pleaseWait.html(this.dictionary.strings.pleaseWait),this.elements.log.wrapper.add(this.elements.summary.success.header).add(this.elements.summary.warning.header).add(this.elements.summary.error.header).add(this.elements.summary.error.message).add(this.elements.summary.warning.message).html(""),this.elements.summary.success.item.add(this.elements.summary.warning.item).add(this.elements.summary.error.item).add(this.elements.summary.success.item).add(this.elements.statusBox.wrapper).add(this.elements.buttons.downloadBtn).add(this.elements.buttons.copyBtn).hide(),this.updateUiEnableStartBtn()},updateUiEnableStartBtn:function(){this.elements.buttons.startBtn.prop("disabled",!1).removeClass("disabled")},updateUiDisableStartBtn:function(){this.elements.buttons.startBtn.prop("disabled",!0).addClass("disabled")},updateUiEnableDownloadBtn:function(){this.elements.buttons.downloadBtn.prop("disabled",!1).removeClass("disabled")},updateUiDisableDownloadBtn:function(){this.elements.buttons.downloadBtn.prop("disabled",!0).addClass("disabled")},updateUiEnableCopyBtn:function(){this.elements.buttons.copyBtn.prop("disabled",!1).removeClass("disabled")},updateUiDisableCopyBtn:function(){this.elements.buttons.copyBtn.prop("disabled",!0).addClass("disabled")},updateUiStatusBoxStop:function(){this.elements.statusBox.title.html(this.dictionary.strings.auditAbortedDueCriticalError),this.elements.statusBox.pleaseWait.html(""),this.elements.statusBox.icon.removeClass("in-progress").addClass("completed")},updateUiFinished:function(t,e,s){return this.updateUiStatusBoxStop(),this.isObjectValid(t)&&this.updateUiShowSummarySuccess(t.header),this.isObjectValid(e)&&this.updateUiShowSummaryWarning(e.header,e.message),this.isObjectValid(s)&&this.updateUiShowSummaryError(s.header,s.message),this.updateUiEnableStartBtn(),this.elements.buttons.copyBtn.show(),""!==this.auditState.downloadUrl&&this.elements.buttons.downloadBtn.show(),!1},updateUiHideStatusBox:function(){this.elements.statusBox.wrapper.hide()},updateUiCriticalDuringProcess:function(t,e,s=!1){this.updateUiEnableStartBtn(),""!==this.auditState.downloadUrl&&this.elements.buttons.downloadBtn.show(),""!==this.elements.log.wrapper.text()&&this.elements.buttons.copyBtn.show(),this.elements.summary.success.item.add(this.elements.summary.warning.item).add(this.elements.summary.error.item).add(this.elements.summary.success.item).hide(),this.elements.summary.error.item.show(),this.updateUiShowSummaryError(t,e),!0===s?this.updateUiHideStatusBox():this.updateUiStatusBoxStop(),this.updateUiStatusBoxValues()},updateUiShowSummaryError:function(t,e){this.elements.summary.error.header.html(t),this.elements.summary.error.message.html(e),this.elements.summary.error.item.show()},updateUiShowSummaryWarning:function(t,e){this.elements.summary.warning.header.html(t),this.elements.summary.warning.message.html(e),this.elements.summary.warning.item.show()},updateUiShowSummarySuccess:function(t){this.elements.summary.success.header.html(t),this.elements.summary.success.item.show()},updateUiStatusBoxValues:function(){this.elements.statusBox.counterWarning.html(this.auditState.warningsTotal),this.elements.statusBox.counterCritical.html(this.auditState.criticalTotal),""!==this.auditState.stageName?this.elements.statusBox.stageName.html("( "+this.auditState.stageName+" )"):this.elements.statusBox.stageName.html("")},updateUiLogScroll:function(){this.elements.log.wrapper.scrollTop(this.elements.log.wrapper.prop("scrollHeight"))},abort:function(t){this.status=this.dictionary.status.error,this.updateLog([{level:"critical",header:this.dictionary.strings.critical,message:t}],JSON.stringify(this.wpAjax.log).toString()),this.updateUiCriticalDuringProcess(this.dictionary.strings.criticalGenericMessage,""),this.status=this.dictionary.status.idle,this.id=""},reset:function(){this.updateUiReset()},registerEvents:function(){this.elements.buttons.startBtn.click(t=>{t.preventDefault(),this.domEventStart()}),this.elements.buttons.downloadBtn.click(t=>{t.preventDefault(),window.location.href=this.auditState.downloadUrl}),this.elements.buttons.copyBtn.click(t=>{t.preventDefault();var t=this.elements.log.wrapper.text(),e=i("<textarea>");i("body").append(e),e.val(t).select(),document.execCommand("copy"),e.remove(),alert("Skopiowano do schowka")})},isObjectValid(t){return"object"==typeof t&&null!==t},updateLog:function(t,e=""){Array.isArray(t)&&t.length&&(t.forEach(t=>{this.updateStateTotal(t),this.elements.log.wrapper.append(this.createLogItemHtml(t.level,t.header,t.message,e))}),this.updateUiLogScroll())},createLogItemHtml:function(t,e,s,a=""){return`
    <td class="line log-entry">
      <span class="line-content">
        <span class="log-level log-level--${t}">${e}</span>
        ${s}<span class="code">${a}</span>
      </span>
    </td>
  `},handleTestId:function(t){},handleFinish:function(t){return""!==t.wcLogUrl&&(this.auditState.downloadUrl=t.wcLogUrl),this.updateLog(t.log),this.auditState.stageName="",this.updateUiStatusBoxValues(),this.updateUiFinished(t.summarySuccess,t.summaryWarning,t.summaryError),this.id="",!1},handleContinue:function(t){if(this.updateLog(t.log),this.status===this.dictionary.status.requestContinue){if(this.testId!==t.testId)return this.abort("testId not match"),!1}else this.testId=t.testId;return""!==t.wcLogUrl&&(this.auditState.downloadUrl=t.wcLogUrl),this.auditState.stageName=t.stageName,this.updateUiStatusBoxValues(),!1},request:function(t){if(this.status===this.dictionary.status.error)return!1;this.post(t,t=>{if(this.wpAjax.log.response=JSON.stringify(t).toString(),0===t)return this.abort(t.toString()),!1;try{if(t.hasOwnProperty("status")&&(t.status===this.dictionary.responseStatus.continue||t.status===this.dictionary.responseStatus.finished)){if(t.status===this.dictionary.responseStatus.continue)return this.handleContinue(t),setTimeout(()=>{this.status=this.dictionary.status.requestContinue,this.request(this.wpAjax.autopayAction.continue)},1e3),!1;if(t.status===this.dictionary.responseStatus.finished)return this.handleFinish(t),!1;if("error"===t.status)return t.hasOwnProperty("message")?this.abort(t.message):this.abort(t.toString()),!1}return this.abort(t.toString()),!1}catch(t){return this.abort(t.message+" "+t.stack),!1}})},domEventStart:function(){this.updateUiStart(),this.request(this.wpAjax.autopayAction.new),this.status=this.dictionary.status.requestNew},getJqueryElementByAttr:function(t,e){if(!["id","name","class"].includes(e))throw new Error('Acceptable values are "id", "name" lub "class".');let s;switch(e){case"id":s="#"+t;break;case"name":s=`[name="${t}"]`;break;case"class":s="."+t}var a=i(s);return 0===a.length?"class"===e?[]:null:"class"===e?a.toArray().map(t=>i(t)):a},post:function(t,e){var t={action:this.wpAjax.adminAjaxActionName,autopay_action:t,nonce:this.wpAjax.nonce,test_id:this.testId},s=(jQuery.ajaxSetup({timeout:3e4}),this.wpAjax.adminAjaxUrl);this.wpAjax.log.request={url:s,data:t},jQuery.post(s,t,e).fail((t,e,s)=>(this.wpAjax.log.request.textStatus=e,this.wpAjax.log.request.errorThrown=s,t.hasOwnProperty("responseText")&&""!==t.responseText?this.abort(t.responseText):this.abort(s),!1))}}).init()});